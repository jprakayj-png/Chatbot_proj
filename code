var CHANNEL_ACCESS_TOKEN = "OxJMnf0ZgAEhP5PVyOVAClCoDo9/pBnkHM+Vc2cAwdzda6+W2ov/M75/FK5a4T8qbA1oQd81sPpNsWxKIm8Xh55J6wvdBuFk6wgruwlfx6NRnmGpq7yy/oH6LUt9j7SKi+wxTYR02iEfT7dQL0GTJgdB04t89/1O/w1cDnyilFU=";

function doPost(e) {
  try {
    var data = JSON.parse(e.postData.contents);
    var event = data.events[0];
    if (!event || !event.replyToken || !event.message) return;

    var token = event.replyToken;
    var msg = event.message.text.trim().toLowerCase();

    // 1. MAIN MENU
    if (msg === "start") {
      replyText(token, "Welcome\n1. Check timetable\n2. Register public transport");
    } 
    
    // 2. CHOOSE DIRECTION (Triggered by typing "1")
    else if (msg === "1" || msg === "check timetable") {
      replyText(token, "Choose direction:\nNorth\nSouth\nEast\nWest");
    }

    // 3. SHOW SCHEDULE (Triggered by a direction)
    else if (msg === "north" || msg === "south" || msg === "east" || msg === "west") {
      var imageMap = {
        // sometimes reply sometimes not reply
        north: "https://raw.githubusercontent.com/jprakayj-png/Chatbot_proj/refs/heads/main/Noth.jpg",
        south: "https://raw.githubusercontent.com/jprakayj-png/Chatbot_proj/refs/heads/main/South.jpg",
        east:  "https://raw.githubusercontent.com/jprakayj-png/Chatbot_proj/refs/heads/main/East.jpg", 
        west:  "https://raw.githubusercontent.com/jprakayj-png/Chatbot_proj/refs/heads/main/West.jpg"
      };
      
      // We send TWO messages here: the Image AND the follow-up question
      replyImageAndText(token, imageMap[msg], "Do you want to register it or not?\n(Yes/No)");
    }

    // 4. FINAL STEPS
    else if (msg === "yes" || msg === "2") {
      replyText(token, "Registration complete. Program ended.");
    }
    else if (msg === "no") {
      replyText(token, "Thankyou for using our service.");
    }

    // FALLBACK
    else {
      replyText(token, "Invalid Input\nTYPE START");
    }

  } catch (err) {
    console.log(err.toString());
  }
}

// HELPER FUNCTION: Sends an image followed by a text message
function replyImageAndText(token, imageUrl, text) {
  var url = "https://api.line.me/v2/bot/message/reply";
  UrlFetchApp.fetch(url, {
    method: "post",
    contentType: "application/json",
    headers: { "Authorization": "Bearer OxJMnf0ZgAEhP5PVyOVAClCoDo9/pBnkHM+Vc2cAwdzda6+W2ov/M75/FK5a4T8qbA1oQd81sPpNsWxKIm8Xh55J6wvdBuFk6wgruwlfx6NRnmGpq7yy/oH6LUt9j7SKi+wxTYR02iEfT7dQL0GTJgdB04t89/1O/w1cDnyilFU=" },
    payload: JSON.stringify({
      replyToken: token,
      messages: [
        {
          type: "image",
          originalContentUrl: imageUrl,
          previewImageUrl: imageUrl
        },
        {
          type: "text",
          text: text
        }
      ]
    })
  });
}

// Standard replyText function
function replyText(token, text) {
  var url = "https://api.line.me/v2/bot/message/reply";
  UrlFetchApp.fetch(url, {
    method: "post",
    contentType: "application/json",
    headers: { "Authorization": "Bearer OxJMnf0ZgAEhP5PVyOVAClCoDo9/pBnkHM+Vc2cAwdzda6+W2ov/M75/FK5a4T8qbA1oQd81sPpNsWxKIm8Xh55J6wvdBuFk6wgruwlfx6NRnmGpq7yy/oH6LUt9j7SKi+wxTYR02iEfT7dQL0GTJgdB04t89/1O/w1cDnyilFU=" },
    payload: JSON.stringify({
      replyToken: token,
      messages: [{ type: "text", text: text }]
    })
  });
}
